# 性能设计

## 概述

### 前言

系统的性能主要指系统的运行速度和稳定性。功能再强大，而性能很差、频繁宕机，系统便失去了可用性，性能好的软件系统能获得更好的用户体验，从而给用户留下高质量软件的良好印象。

在架构设计初期就一定要把系统性能考虑在内。否则等开发完成以后测试发现性能不好就比较难办，通常要花费较长的时间来诊断性能瓶颈，找到提升的办法，甚至要改变架构，伤筋动骨，导致项目延期。所以性能设计首先要有明确的性能目标，根据用户和软件本身的性能要求来设计，合适的就是最好的。其次，要有适当的度量标准和量化的性能指标。最后，要有相应的设计策略、应对方案和具体的测试方法。因此，在进行架构设计中性能设计非常重要。

### 一些性能指标的概念

- 响应时间：指系统对请求作出响应的时间。包括某个功能或所有功能的平均时间、最大响应时间。
- 吞吐量：指系统在单位时间内处理请求的数量。对于无并发的应用系统而言，吞吐量与响应时间成严格的反比关系。对于单用户的系统，响应时间可以很好地度量系统的性能，但对于并发系统，通常需要用吞吐量作为性能指标。
- 并发用户数：并发用户数是指系统可以同时承载的正常使用系统功能的用户的数量。与吞吐量相比，并发用户数是一个更直观、更笼统、不够准确的性能指标。相比而言，以在线用户作为性能指标更直观些，而以同时发请求用户数作为性能指标更准确些。
- QPS：即每秒查询率（Query Per Second）。对一个特定的查询服务器在规定时间内所处理流量多少的衡量标准。

### 公司的简要性能目标

> 开发过程中应引入加压开发，数据库中须模拟 3 年业务的数据量。调试功能时应保障基本执行效率，除统计分析类页面外，页面操作的响应时间应在 3s 以内；统计分析类页面操作的响应时间不得超过5s。—— 2017版技术标准之4.6.10章节。

## 影响性能的主要因素

影响系统性能主要瓶颈在**I/O**，包括**数据库**，**socket**，**网络通信**，**文件**等，例如频繁查询数据库并返回大量结果集，频繁操作大文件等，这些昂贵的操作会占用大量的CPU时间。所以性能设计时一定要考虑到I/O，同步，并发，资源争用，以及大数据量等因素。

性能涉及到系统的各个环节，包括：

- 硬件资源：CPU、内存、存储系统、带宽等
- 操作系统：IO性能（存储设备IO、网络设备IO、异步IO）、文件系统性能（大文件、小文件、读写优化、网络文件系统）、多线程性能等
- 服务器软件、中间件软件等：数据库、JDK、Servlet容器、Http服务器等
- 应用程序：SQL书写、数据结构和算法、表结构设计问题等

> 通常，I/O操作、网络响应、差的数据结构和算法、数据库、以及其他的低效的资源使用都会导致低劣的性能。

## 常见性能设计和优化策略

### 调整或升级硬件

升级硬件的方式包括增加内存、升级硬盘为SSD、使用多块硬盘做磁盘阵列（RAID），增加网络带宽等。

通过硬件的升级可以快速解决系统性能问题，对于可预估的系统容量性价比很好。但顶配或者新出来的硬件贵得离谱，最新的硬件往往也会存在一些未知的BUG， 所以硬件升级一般不会选择1年内出来的全新架构的设备，而通常选择2年以上比较成熟的硬件性价比会更好。但是硬件升级往往会有上限，顶配或者最高性能的硬件往往性价比不好，所以在硬件升级解决问题后同时需要分析业务增长导致更多硬件成本的问题。选择软件优化还是硬件优化是一种技术成本平衡决策。

### 数据库性能设计和优化

目前公司业务系统性能的瓶颈主要在数据库层次的性能。所以，设计和优化出性能更好的数据库层的性能就显得尤为重要了。

- 根据业务和数据量选择数据存储方案，如：内存数据库、关系型数据库、非关系型数据库等。
- 根据数据量的规模和业务场景，判断是否需要使用分布式的方式，如：主从模式、实时应用集群（RAC）；是否需要做负载均衡、分库分表、读写分离、修改数据库配置参数等。
- 根据存储方式和业务需求，设计和调整更优的数据结构，使得存储和查询数据性能更好，开发人员易于书写简单、高效的SQL语句。如：拆分表数据、正确的数据类型、建立正确的索引、合理的冗余字段等手段。
- 在业务程序开发阶段，需要注意以下几点：
  - 使用数据库连接池
  - 避免全表扫描和超过4张表及以上的表连接
  - 查询结果列和结果集尽量小，大数量的查询、排序、分组等尽量利用和使用上索引
  - 关键、复杂的业务建立事务，缩小事务范围
  - 使用存储过程来开发和优化需要高性能的业务场景
  - 单个业务操作避免复杂的、慢的和过多的SQL
  - 避免循环或递归中查询数据库数据。
  - 根据数据量和使用业务场景，对分页方式做调整和性能优化

### 缓存及缓存层

缓存无处不在，硬件上看，有硬盘缓存，存储缓存等。软件架构上看，有全局数据缓存，连接池，应用服务器缓存，WEB服务器缓存，CDN缓存，客户端文件缓存，客户端内存缓存等等。基本上大型系统都会有很多级缓存，否则需要非常高的硬件投入才能解决问题。

在业务系统的缓存设计上，数据层和应用层之间会增加数据缓存层，提供全局数据服务。可以大大减少数据库往返次数。与读取数据库和读取大文件（如`XML`文件）比，读取内存的速度无疑要快的多。所以对经常要访问的数据进行缓存是非常好的实践方法。因为现在系统往往内存很大，可以充分利用大内存，而共享内存更能实现数据并发访问。对于中小型系统，不建议有复杂的缓存架构，因为让系统能更快速发展比提供更好的性能更有意义，复杂的缓存架构往往需要投入更多的人力成本。

### 负载均衡

负载均衡(`Load Balance`)通常是指将请求/数据均匀的分摊到多个操作单元上执行，负载均衡的关键在于**均匀**。负载均衡在各个软件层次都有使用，主要有以下几种：

- 客户端层->反向代理层的负载均衡：是通过**DNS轮询**来实现的。DNS服务器对于一个域名配置了多个解析IP，每次DNS解析请求来访问DNS服务器，会轮询返回这些IP，保证每个IP的解析概率是相同的。
- 反向代理层->站点层的负载均衡：是通过“nginx”实现的。通过修改`nginx.conf`，可以实现多种负载均衡策略：请求轮询（和DNS轮询类似）、最少连接路由、IP哈希等。
- 站点层->服务层的负载均衡：是通过**服务连接池**实现的。Web服务器连接池会建立与服务的多个连接，每次请求会**随机**选取连接来访问下游服务。
- 数据层的负载均衡：数据层的负载均衡更为分为**数据的均衡**（数据水平切分），与**请求的均衡**。
  - 数据的均衡：是指水平切分后的每个服务(数据库或缓存)，数据量是差不多的。
  - 请求的均衡：是指水平切分后的每个服务(数据库或缓存)，请求量是差不多的。

### 程序性能设计

在程序开发和实现上，代码性能设计也很重要，一些昂贵的操作会占用大量的资源和`CPU`时间。所以，Java程序的性能设计上需要注意以下情形：

- 避免循环中查询数据库
- 减少时间复杂度，减少循环嵌套层数
- 使用异步或多线程的方式来处理多个任务
- 循环中对字符串相加使用`StringBuilder`
- 避免频繁创建对象，尽量重用对象
- 差劲的数据结构和算法
- 避免过多的拆装箱操作
- 避免循环中处理异常
- 避免过多的使用反射（`Reflection`）
- 使用`ConcurrentHashMap`来替换`HashTable`达到线程安全
- 尽量指定类、方法的final修饰符
- ...

### 文件操作设计

项目中会经常涉及到文件的读写、传输和序列化等操作，涉及文件操作相关的设计主要有以下几点：

- 避免对大文件的频繁读写操作, 频繁打开关闭文件对系统性能下降程度是惊人的
- 使用`BufferedReader`、`BufferedWriter`来替换其它`Java IO`操作的方式操作纯文本文件
- 使用`Java NIO`的方式来替换常规的`Java IO`流的方式来读写文件，从而使读写效率更高
- 使用`Json`文件的方式来替换传统冗长的`XML`文件的方式来做数据传输交换的文件格式，`JSON`文件小巧、传输快、易于代码读写转换，且便于阅读
- 使用压缩文件做数据传输，是传输更快（时间换空间）
- 使用FTP服务器或Minio Cloud Storage来做文件的存储服务

### 应用层功能设计和改造

应用层需要根据实际需求和应用场景来做性能设计。以下是我就某些应用业务场景做的一些设计或优化经验：

- 优化Artery分页，在翻页时不查数据总数，仅在刷新当前页和重新开始查询时再查总数
- 前后端分离，客户端异步请求后端数据，优化数据加载、页面元素的展现逻辑
- 使用`Elastic Search`来处理大数据量中需要实时查询数据的场景

## 性能设计和优化的主要思想

### 降低数量级

性能问题引起的本质原因是现有的软硬件架构无法单独处理大数据量级的数据。所以，解决性能问题的最好方式就是在软硬件的各个层次去不断的降低需要处理数据的数量级。比如：数据库数据量过大，采用分库分表的思路去降低某些数据的数量级，从而在小数量级的数据上做操作，性能明显更好。所以，降低待处理数据的数量级也发生在各个软硬件层次，如以下这些情形：

- 分库分表分区，在更小的数据量和磁盘上做操作，效率更高。
- 分页查询，只处理和展示部分数据，通过翻页的方式来查看其他数据。
- 通过更好的数据格式和压缩文件等方式来减小数据传输，比如：使用`ProtoBuf`、`JSON`等更轻量级的方案来替代XML，使用压缩比更高（7z）的算法来压缩文件等。

### 良好的资源管理

软件系统本质上是对资源的管理、请求、使用和消耗。所以，恰当有效的使用资源、减少对系统资源的请求、避免不必要的资源消耗等方式是提高软件程序性能设计和优化的关键。

### 分

**分**的思想是用来降低待处理数据的数量级的最好方式，也是高性能系统设计和优化最重要的原则。包括了按业务分、按逻辑结构、按层次分、按数据量分（分库分表）、按读写分、按流量分（负载均衡）、按时间分（异步化）等。

例如：Java中提供的线程安全和高性能的`ConcurrentHashMap`就是基于了**分**(分段锁)的思想来实现的。一个`ConcurrentHashMap`由多个`segment`组成，每一个`segment`都包含了一个`HashEntry`数组的`HashTable`， 每一个`segment`包含了对自己的`HashTable`的操作，比如`get`，`put`，`replace`等操作，这些操作发生的时候，对自己的`HashTable`进行锁定。由于每一个`segment`写操作只锁定自己的`HashTable`，所以可能存在多个线程同时写的情况，性能无疑好于只有一个`HashTable`锁定的情况。

### 空间换时间

对于程序开发来说，**时间复杂度和空间复杂度是可以相互转化的**。也就是说：对于执行的慢的程序，可以通过消耗内存（即构造新的数据结构）来进行优化。而消耗内存的程序，也可以多消耗时间来降低内存的消耗。前者即空间换时间是使用的最多的。例如：Java开发中，不可避免的会使用到**双重for**循环的场景，时间复杂度为O(n^2)，通过Map来优化到时间复杂度为O(n)，但会占用了更多的空间。其它使用情况比如：

- 索引
- 预计算（统计数据、报表数据）
- 静态化
- 冗余

### 缓存

**缓存**是为了解决频繁重复且“耗时”的请求和操作而生的，是实现高性能的重要方式。缓存分为：本地缓存（HashMap/ConcurrentHashMap、Ehcache、Guava Cache等），缓存服务（Redis/Memcache）等。以下是关于缓存选型方案：

- 如果数据量小，并且不会频繁地增长又清空（这会导致频繁地垃圾回收），那么可以选择本地缓存。具体的话，如果需要一些策略的支持（比如缓存满的逐出策略），可以考虑`Ehcache`；如不需要，可以考虑`ConcurentHashMap`。
- 数据量大且具有更复杂的业务场景时，可以考虑缓存服务，如`Redis`和`Memcache`等。

### 池化

由于在软件程序中，某些资源或对象的创建、初始化等操作开销大，采用**池化**的思想是为了较少耗时对象生成或初始化的次数，从而提高整体的性能。然而池化处理本身也要付出代价。因此，并非任何情况下都适合采用池化的思想。一般是对像网络连接、数据库连接、线程等重量级的对象做池化，使用池化的地方主要有以下一些场景：

- 数据库连接池
- socket连接池
- 线程池
- 字符串常量池

恰当地使用对象池化，可以有效地降低频繁创建或初始化某些对象所造成的开销，从而提高整体的性能。而借助对象池组件，可以有效地减少花在处理对象池化上的工作量。

## 总结

性能设计是一个不断尝试和进化的过程。以上只是我个人项目经验的积累和归纳，水平有限，项目有限，认识更有限，欢迎大家指正补充。