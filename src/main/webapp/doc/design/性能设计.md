# 性能设计

## 概述

### 前言

系统的性能主要指系统的运行速度和稳定性。功能再强大，而性能很差、频繁宕机，系统便失去了可用性，性能好的软件系统能获得更好的用户体验，从而给用户留下高质量软件的良好印象。

在架构设计初期就一定要把系统性能考虑在内。否则等开发完成以后测试发现性能不好就比较难办，通常要花费较长的时间来诊断性能瓶颈，找到提升的办法，甚至要改变架构，伤筋动骨，导致项目延期。所以性能设计首先要有明确的性能目标，根据用户和软件本身的性能要求来设计，合适的就是最好的。其次，要有适当的度量标准和量化的性能指标。最后，要有相应的设计策略、应对方案和具体的测试方法。因此，在进行架构设计中性能设计非常重要。

### 一些性能指标的概念

- 响应时间：指系统对请求作出响应的时间。包括某个功能或所有功能的平均时间、最大响应时间。
- 吞吐量：指系统在单位时间内处理请求的数量。对于无并发的应用系统而言，吞吐量与响应时间成严格的反比关系。对于单用户的系统，响应时间可以很好地度量系统的性能，但对于并发系统，通常需要用吞吐量作为性能指标。
- 并发用户数：并发用户数是指系统可以同时承载的正常使用系统功能的用户的数量。与吞吐量相比，并发用户数是一个更直观、更笼统、不够准确的性能指标。相比而言，以在线用户作为性能指标更直观些，而以同时发请求用户数作为性能指标更准确些。
- QPS：即每秒查询率（Query Per Second）。对一个特定的查询服务器在规定时间内所处理流量多少的衡量标准。

### 公司的简要性能目标

> 开发过程中应引入加压开发，数据库中须模拟 3 年业务的数据量。调试功能时应保障基本执行效率，除统计分析类页面外，页面操作的响应时间应在 3s 以内；统计分析类页面操作的响应时间不得超过5s。—— 2017版技术标准之4.6.10章节。

## 影响性能的主要因素

影响系统性能主要瓶颈在**I/O**，包括**数据库**，**socket**，**网络通信**，**文件**等，例如频繁查询数据库并返回大量结果集，频繁操作大文件等，这些昂贵的操作会占用大量的CPU时间。所以性能设计时一定要考虑到I/O，同步，并发，资源争用，以及大数据量等因素。

性能涉及到系统的各个环节，包括：

- 硬件资源：CPU、内存、存储系统、带宽等
- 操作系统：IO性能（存储设备IO、网络设备IO、异步IO）、文件系统性能（大文件、小文件、读写优化、网络文件系统）、多线程性能等
- 服务器软件、中间件软件等：数据库、JDK、Servlet容器、Http服务器等
- 应用程序：SQL书写、数据结构和算法、表结构设计问题等

> 通常，I/O操作、网络响应、差的数据结构和算法、数据库、以及其他的低效的资源使用都会导致低劣的性能。

## 常见性能设计和优化策略

### 调整或升级硬件

升级硬件的方式包括增加内存、升级硬盘为SSD、使用多块硬盘做磁盘阵列（RAID），增加网络带宽等。

通过硬件的升级可以快速解决系统性能问题，对于可预估的系统容量性价比很好。但顶配或者新出来的硬件贵得离谱，最新的硬件往往也会存在一些未知的BUG， 所以硬件升级一般不会选择1年内出来的全新架构的设备，而通常选择2年以上比较成熟的硬件性价比会更好。但是硬件升级往往会有上限，顶配或者最高性能的硬件往往性价比不好，所以在硬件升级解决问题后同时需要分析业务增长导致更多硬件成本的问题。选择软件优化还是硬件优化是一种技术成本平衡决策。

### 数据库性能设计和优化

目前公司业务系统性能的瓶颈主要在数据库层次的性能。所以，设计和优化出性能更好的数据库层的性能就显得尤为重要了。

- 根据业务和数据量选择数据存储方案，如：内存数据库、关系型数据库、非关系型数据库等。
- 根据数据量的规模和业务场景，判断是否需要使用分布式的方式，如：主从模式、实时应用集群（RAC）；是否需要做负载均衡、分库分表、读写分离、修改数据库配置参数等。
- 根据存储方式和业务需求，设计和调整更优的数据结构，使得存储和查询数据性能更好，开发人员易于书写简单、高效的SQL语句。如：拆分表数据、正确的数据类型、建立正确的索引、合理的冗余字段等手段。
- 在业务程序开发阶段，需要注意以下几点：
  - 使用数据库连接池
  - 避免全表扫描和超过4张表及以上的表连接
  - 查询结果列和结果集尽量小，大数量的查询、排序、分组等尽量利用和使用上索引
  - 关键、复杂的业务建立事务
  - 使用存储过程来开发和优化需要高性能的业务场景
  - 单个业务操作避免复杂的、慢的和过多的SQL
  - 避免循环或递归中查询数据库数据。
  - 根据数据量和使用业务场景，对分页方式做调整和性能优化
