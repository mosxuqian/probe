# Java异常

## 前言

### 为什么要使用异常

在我们的程序中，任何时候任何地方因为任何原因都有可能会出现异常，在没有异常机制的时候我们是这样处理的：通过函数的返回值来判断是否发生了异常（这个返回值通常是已经约定好了的），调用该函数的程序负责检查并且分析返回值。虽然可以解决异常问题，但是这样做存在几个缺陷：

- 容易混淆。如果约定返回值为 -1 时表示出现异常，那么当程序最后的计算结果真的为 -1 呢？
- 代码可读性差。将异常处理代码和程序代码混淆在一起将会降低代码的可读性。
- 由调用函数来分析异常，这要求程序员对库函数有很深的了解。

> 在面向对象编程中提供的异常处理机制是提供代码健壮的强有力的方式。使用异常机制它能够降低错误处理代码的复杂度，如果不使用异常，那么就必须检查特定的错误，并在程序中的许多地方去处理它，而如果使用异常，那就不必在方法调用处进行检查，因为异常机制将保证能够捕获这个错误，并且，只需在一个地方处理错误，即所谓的异常处理程序中。这种方式不仅节约代码，而且把“概述在正常执行过程中做什么事”的代码和“出了问题怎么办”的代码相分离。总之，与以前的错误处理方法相比，异常机制使代码的阅读、编写和调试工作更加井井有条。（摘自《Think in java 》）。

### 基本定义

> 异常情形是指阻止当前方法或者作用域继续执行的问题。——《Think in java》

总的来说异常处理机制就是当程序发生异常时，它强制终止程序运行，记录异常信息并将这些信息反馈给我们，由我们来确定是否处理异常。

## 异常体系

在Java中，所有的事件都能由类描述，Java中的异常就是由`java.lang`包下的异常类来描述的。Java定义了一个异常类的层次结构，其以`Throwable`（万物即可抛）开始，派生出了`Error`和`Exception`，而`Exception`又派生出了`CheckedException`和`RuntimeException`。如下图所示：

### Throwable

Throwable（可抛出）是异常类的最终父类，它有两个子类，`Error`与`Exception`。

Throwable 中常用方法有：

- `getCause()`：返回抛出异常的原因。如果 cause 不存在或未知，则返回`null`。
- `getMessage()`：返回异常的消息信息。
- `printStackTrace()`：对象的堆栈跟踪输出至错误输出流，作为字段`System.err`的值。
- `toString()`：返回此`throwable`的简短描述。

### Error

Error（错误）：表示程序无法处理的错误，一般与程序员的执行操作无关。理论上这些错误是不允许发生的，如果发生，也不应该试图通过程序去处理，所以 Error 不是`try-catch`的处理对象，而 JVM 一般的处理方式是终止发生错误的线程。Error 类常见子类有`VirtualMachineError`、`StackOverFlowError`、`OutOfMemoryError`等。

在Java运行时内存中，除程序计数器外的虚拟机栈、堆、方法区在请求的内存无法被满足时都会抛出`OutOfMemoryError`；而如果线程请求的栈深度超出虚拟机允许的深度时，就会抛出`StackOverFlowError`。

### Exception

Exception（异常）：出现原因取决于程序，所以程序也理应通过`try-catch`处理。Exception 异常分为两类：`CheckedException`和`RuntimeException`，即**检查异常**与**运行时异常**。

- 检查异常：编译器要求必须处理，否则不能通过编译，使用`try-catch`捕获或者`throws`抛出。常见的检查异常有`IOException`及其子类、`EOFExcption`(文件已结束异常)、`FileNotFoundException`（文件未找到异常）。
- 运行时异常（也叫非检查异常）：编译期不会检查，所以在程序中可不处理，但如果发生，会在运行时抛出。

## 异常处理机制

在 Java 应用程序中，异常处理机制为：**抛出异常**、**捕捉异常**。

- **抛出异常**：当一个方法出现错误引发异常时，方法创建异常对象并交付运行时系统，异常对象中包含了异常类型和异常出现时的程序状态等异常信息。运行时系统负责寻找处置异常的代码并执行。
- **捕获异常**：在方法抛出异常之后，运行时系统将转为寻找合适的异常处理器。潜在的异常处理器是异常发生时依次存留在调用栈中的方法的集合。当异常处理器所能处理的异常类型与方法抛出的异常类型相符时，即为合适 的异常处理器。运行时系统从发生异常的方法开始，依次回查调用栈中的方法，直至找到含有合适异常处理器的方法并执行。当运行时系统遍历调用栈而未找到合适的异常处理器，则运行时系统终止。同时，意味着Java程序的终止。

对于运行时异常、错误或可查异常，Java技术所要求的异常处理方式有所不同。

- 对于方法运行中可能出现的Error，当运行方法不欲捕捉时，Java允许该方法不做任何抛出声明。因为，大多数 Error 异常属于永远不能被允许发生的状况，也属于合理的应用程序不该捕捉的异常。
- 对于所有的检查异常，Java规定：**一个方法必须捕捉，或者声明抛出方法之外。也就是说，当一个方法选择不捕捉检查异常时，它必须声明将抛出异常**。
- 对于所有运行时异常，Java规定：**运行时异常将由Java运行时系统自动抛出，允许应用程序忽略运行时异常**。

能够捕捉异常的方法，需要提供相符类型的异常处理器。所捕捉的异常，可能是由于自身语句所引发并抛出的异常，也可能是由某个调用的方法或者Java运行时 系统等抛出的异常。也就是说，一个方法所能捕捉的异常，一定是Java代码在某处所抛出的异常。简单地说，异常总是先被抛出，后被捕捉的。

任何Java代码都可以通过 Java 的`throw`语句抛出异常。

从方法中抛出的任何异常都必须使用`throws`子句。

捕捉异常通过`try-catch`语句或者`try-catch-finally`语句实现。

> 总体来说，Java规定：对于检查异常必须捕捉、或者声明抛出。允许忽略非检查的`RuntimeException`和`Error`。